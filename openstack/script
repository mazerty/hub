---
- include: script-common-upgrade

- apt-get -y install python-openstackclient

- apt-get -y install mariadb-server
- apt-get -y install python-pymysql
- lookup: mysql-config
  path: /etc/mysql/mariadb.conf.d/99-openstack.cnf
# mysql_secure_installation

- apt-get -y install rabbitmq-server
- rabbitmqctl add_user openstack RABBIT_PASS
- rabbitmqctl set_permissions openstack ".*" ".*" ".*"

- apt-get -y install memcached
- apt-get -y install python-memcache

- apt-get -y install etcd
- lookup: etcd-config
  path: /var/tmp/etcd-config
- cat /var/tmp/etcd-config >> /etc/default/etcd

# mysql
# CREATE DATABASE keystone;
# GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' IDENTIFIED BY 'KEYSTONE_DBPASS';
# GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'KEYSTONE_DBPASS';
- apt-get -y install keystone apache2 libapache2-mod-wsgi
# [database]
# connection = mysql+pymysql://keystone:KEYSTONE_DBPASS@127.0.0.1/keystone
# [token]
# provider = fernet
- su -s /bin/sh -c "keystone-manage db_sync" keystone
- keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
- keystone-manage credential_setup --keystone-user keystone --keystone-group keystone
- keystone-manage bootstrap --bootstrap-password ADMIN_PASS --bootstrap-admin-url http://127.0.0.1:5000/v3/ --bootstrap-internal-url http://127.0.0.1:5000/v3/ --bootstrap-public-url http://127.0.0.1:5000/v3/ --bootstrap-region-id RegionOne

# export OS_USERNAME=admin
# export OS_PASSWORD=ADMIN_PASS
# export OS_PROJECT_NAME=admin
# export OS_USER_DOMAIN_NAME=Default
# export OS_PROJECT_DOMAIN_NAME=Default
# export OS_AUTH_URL=http://127.0.0.1:5000/v3
# export OS_IDENTITY_API_VERSION=3

- openstack domain create --description "An Example Domain" example

- include: script-common-reboot
