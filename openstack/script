---
- include: script-common-upgrade

- apt-get -y install python-openstackclient

- apt-get -y install mariadb-server
- apt-get -y install python-pymysql
- lookup: mysql-config
  path: /etc/mysql/mariadb.conf.d/99-openstack.cnf
- systemctl restart mariadb.service
- mysql -e "UPDATE mysql.user SET Password=PASSWORD('$esc_pass') WHERE User='root';"
- mysql -e "DELETE FROM mysql.user WHERE User='';"
- mysql -e "DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');"
- mysql -e "DROP DATABASE IF EXISTS test;"
- mysql -e "DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';"
- mysql -e "FLUSH PRIVILEGES;"

- apt-get -y install rabbitmq-server
- rabbitmqctl add_user openstack RABBIT_PASS
- rabbitmqctl set_permissions openstack ".*" ".*" ".*"

- apt-get -y install memcached
- apt-get -y install python-memcache

- apt-get -y install etcd
- lookup: etcd-config
  path: /var/tmp/etcd-config
- cat /var/tmp/etcd-config >> /etc/default/etcd
- systemctl enable etcd.service
- systemctl restart etcd.service

- mysql -e "CREATE DATABASE keystone;"
- mysql -e "GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' IDENTIFIED BY 'KEYSTONE_DBPASS';"
- mysql -e "GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'KEYSTONE_DBPASS';"

- apt-get -y install keystone apache2 libapache2-mod-wsgi
- apt-get -y install crudini
- crudini --set /etc/keystone/keystone.conf database connection "mysql+pymysql://keystone:KEYSTONE_DBPASS@127.0.0.1/keystone"
- crudini --set /etc/keystone/keystone.conf token provider fernet
- su -s /bin/sh -c "keystone-manage db_sync" keystone
- keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
- keystone-manage credential_setup --keystone-user keystone --keystone-group keystone
- keystone-manage bootstrap --bootstrap-password ADMIN_PASS --bootstrap-admin-url http://127.0.0.1:5000/v3/ --bootstrap-internal-url http://127.0.0.1:5000/v3/ --bootstrap-public-url http://127.0.0.1:5000/v3/ --bootstrap-region-id RegionOne

- lookup: adminrc
  path: /root/adminrc
