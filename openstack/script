---
- include: script-common-upgrade

- apt-get -y install python-openstackclient

- apt-get -y install mariadb-server
- apt-get -y install python-pymysql
- lookup: mysql-config
  path: /etc/mysql/mariadb.conf.d/99-openstack.cnf
- systemctl restart mariadb.service
- mysql -e "UPDATE mysql.user SET Password=PASSWORD('$esc_pass') WHERE User='root';"
- mysql -e "DELETE FROM mysql.user WHERE User='';"
- mysql -e "DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');"
- mysql -e "DROP DATABASE IF EXISTS test;"
- mysql -e "DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';"
- mysql -e "FLUSH PRIVILEGES;"

- apt-get -y install rabbitmq-server
- rabbitmqctl add_user openstack RABBIT_PASS
- rabbitmqctl set_permissions openstack ".*" ".*" ".*"

- apt-get -y install memcached
- apt-get -y install python-memcache

- apt-get -y install etcd
- lookup: etcd-config
  path: /var/tmp/etcd-config
- cat /var/tmp/etcd-config >> /etc/default/etcd
- systemctl enable etcd.service
- systemctl restart etcd.service

- mysql -e "CREATE DATABASE keystone;"
- mysql -e "GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' IDENTIFIED BY 'KEYSTONE_DBPASS';"
- mysql -e "GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'KEYSTONE_DBPASS';"

- apt-get -y install keystone apache2 libapache2-mod-wsgi
- apt-get -y install crudini
- crudini --set /etc/keystone/keystone.conf database connection "mysql+pymysql://keystone:KEYSTONE_DBPASS@127.0.0.1/keystone"
- crudini --set /etc/keystone/keystone.conf token provider fernet
- su -s /bin/sh -c "keystone-manage db_sync" keystone
- keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
- keystone-manage credential_setup --keystone-user keystone --keystone-group keystone
- keystone-manage bootstrap --bootstrap-password ADMIN_PASS --bootstrap-admin-url http://127.0.0.1:5000/v3/ --bootstrap-internal-url http://127.0.0.1:5000/v3/ --bootstrap-public-url http://127.0.0.1:5000/v3/ --bootstrap-region-id RegionOne

- lookup: adminrc
  path: /root/adminrc
- . /root/adminrc && openstack project create --domain default --description "Service Project" service
- . /root/adminrc && openstack project create --domain default --description "Demo Project" demo
- . /root/adminrc && openstack user create --domain default --password password demo
- . /root/adminrc && openstack role create user
- . /root/adminrc && openstack role add --project demo --user demo user
- . /root/adminrc && openstack token issue

- lookup: demorc
  path: /root/demorc
- . /root/demorc && openstack token issue

- mysql -e "CREATE DATABASE glance;"
- mysql -e "GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' IDENTIFIED BY 'GLANCE_DBPASS';"
- mysql -e "GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' IDENTIFIED BY 'GLANCE_DBPASS';"
- . /root/adminrc && openstack user create --domain default --password password glance
- . /root/adminrc && openstack role add --project service --user glance admin
- . /root/adminrc && openstack service create --name glance --description "OpenStack Image" image
- . /root/adminrc && openstack endpoint create --region RegionOne image public http://127.0.0.1:9292
- . /root/adminrc && openstack endpoint create --region RegionOne image admin http://127.0.0.1:9292
- . /root/adminrc && openstack endpoint create --region RegionOne image internal http://127.0.0.1:9292

- apt-get -y install glance
- crudini --set /etc/glance/glance-api.conf database connection "mysql+pymysql://glance:GLANCE_DBPASS@127.0.0.1/glance"
- crudini --set /etc/glance/glance-api.conf keystone_authtoken auth_uri http://127.0.0.1:5000
- crudini --set /etc/glance/glance-api.conf keystone_authtoken auth_url http://127.0.0.1:5000
- crudini --set /etc/glance/glance-api.conf keystone_authtoken memcached_servers 127.0.0.1:11211
- crudini --set /etc/glance/glance-api.conf keystone_authtoken auth_type password
- crudini --set /etc/glance/glance-api.conf keystone_authtoken project_domain_name Default
- crudini --set /etc/glance/glance-api.conf keystone_authtoken user_domain_name Default
- crudini --set /etc/glance/glance-api.conf keystone_authtoken project_name service
- crudini --set /etc/glance/glance-api.conf keystone_authtoken username glance
- crudini --set /etc/glance/glance-api.conf keystone_authtoken password password
- crudini --set /etc/glance/glance-api.conf paste_deploy flavor keystone
- crudini --set /etc/glance/glance-api.conf glance_store stores file,http
- crudini --set /etc/glance/glance-api.conf glance_store default_store file
- crudini --set /etc/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/

- crudini --set /etc/glance/glance-registry.conf database connection "mysql+pymysql://glance:GLANCE_DBPASS@127.0.0.1/glance"
- crudini --set /etc/glance/glance-registry.conf keystone_authtoken auth_uri http://127.0.0.1:5000
- crudini --set /etc/glance/glance-registry.conf keystone_authtoken auth_url http://127.0.0.1:5000
- crudini --set /etc/glance/glance-registry.conf keystone_authtoken memcached_servers 127.0.0.1:11211
- crudini --set /etc/glance/glance-registry.conf keystone_authtoken auth_type password
- crudini --set /etc/glance/glance-registry.conf keystone_authtoken project_domain_name Default
- crudini --set /etc/glance/glance-registry.conf keystone_authtoken user_domain_name Default
- crudini --set /etc/glance/glance-registry.conf keystone_authtoken project_name service
- crudini --set /etc/glance/glance-registry.conf keystone_authtoken username glance
- crudini --set /etc/glance/glance-registry.conf keystone_authtoken password password
- crudini --set /etc/glance/glance-registry.conf paste_deploy flavor keystone

- su -s /bin/sh -c "glance-manage db_sync" glance
- systemctl restart glance-registry.service
- systemctl restart glance-api.service

- wget https://download.cirros-cloud.net/0.5.1/cirros-0.5.1-x86_64-disk.img -O /tmp/cirros-0.5.1-x86_64-disk.img

- . /root/adminrc && openstack image create "cirros" --file /tmp/cirros-0.5.1-x86_64-disk.img --disk-format qcow2 --container-format bare --public

- mysql -e "CREATE DATABASE nova_api;"
- mysql -e "GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'localhost' IDENTIFIED BY 'NOVA_DBPASS';"
- mysql -e "GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'%' IDENTIFIED BY 'NOVA_DBPASS';"
- mysql -e "CREATE DATABASE nova;"
- mysql -e "GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' IDENTIFIED BY 'NOVA_DBPASS';"
- mysql -e "GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' IDENTIFIED BY 'NOVA_DBPASS';"
- mysql -e "CREATE DATABASE nova_cell0;"
- mysql -e "GRANT ALL PRIVILEGES ON nova_cell0.* TO 'nova'@'localhost' IDENTIFIED BY 'NOVA_DBPASS';"
- mysql -e "GRANT ALL PRIVILEGES ON nova_cell0.* TO 'nova'@'%' IDENTIFIED BY 'NOVA_DBPASS';"
- . /root/adminrc && openstack user create --domain default --password password nova
- . /root/adminrc && openstack role add --project service --user nova admin
- . /root/adminrc && openstack service create --name nova --description "OpenStack Compute" compute
- . /root/adminrc && openstack endpoint create --region RegionOne compute public http://127.0.0.1:8774/v2.1
- . /root/adminrc && openstack endpoint create --region RegionOne compute admin http://127.0.0.1:8774/v2.1
- . /root/adminrc && openstack endpoint create --region RegionOne compute internal http://127.0.0.1:8774/v2.1
- . /root/adminrc && openstack user create --domain default --password password placement
- . /root/adminrc && openstack role add --project service --user placement admin
- . /root/adminrc && openstack service create --name placement --description "OpenStack Placement" placement
- . /root/adminrc && openstack endpoint create --region RegionOne placement public http://127.0.0.1:8778
- . /root/adminrc && openstack endpoint create --region RegionOne placement admin http://127.0.0.1:8778
- . /root/adminrc && openstack endpoint create --region RegionOne placement internal http://127.0.0.1:8778

- apt-get -y install nova-api nova-conductor nova-consoleauth nova-novncproxy nova-scheduler nova-placement-api
- crudini --set /etc/nova/nova.conf api_database connection "mysql+pymysql://nova:NOVA_DBPASS@127.0.0.1/nova_api"
- crudini --set /etc/nova/nova.conf database connection "mysql+pymysql://nova:NOVA_DBPASS@127.0.0.1/nova"
- crudini --set /etc/nova/nova.conf keystone_authtoken auth_url http://127.0.0.1:5000/v3
- crudini --set /etc/nova/nova.conf keystone_authtoken memcached_servers 127.0.0.1:11211
- crudini --set /etc/nova/nova.conf keystone_authtoken auth_type password
- crudini --set /etc/nova/nova.conf keystone_authtoken project_domain_name default
- crudini --set /etc/nova/nova.conf keystone_authtoken user_domain_name default
- crudini --set /etc/nova/nova.conf keystone_authtoken project_name service
- crudini --set /etc/nova/nova.conf keystone_authtoken username nova
- crudini --set /etc/nova/nova.conf keystone_authtoken password password
- crudini --set /etc/nova/nova.conf api auth_strategy keystone
- crudini --set /etc/nova/nova.conf DEFAULT transport_url "rabbit://openstack:RABBIT_PASS@127.0.0.1"
- crudini --set /etc/nova/nova.conf DEFAULT my_ip 127.0.0.1
- crudini --set /etc/nova/nova.conf DEFAULT use_neutron True
- crudini --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver
- crudini --del /etc/nova/nova.conf DEFAULT log_dir
- crudini --set /etc/nova/nova.conf vnc enabled true
- crudini --set /etc/nova/nova.conf vnc server_listen 127.0.0.1
- crudini --set /etc/nova/nova.conf vnc server_proxyclient_address 127.0.0.1
- crudini --set /etc/nova/nova.conf glance api_servers http://127.0.0.1:9292
- crudini --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp
- crudini --set /etc/nova/nova.conf placement os_region_name RegionOne
- crudini --set /etc/nova/nova.conf placement project_domain_name Default
- crudini --set /etc/nova/nova.conf placement project_name service
- crudini --set /etc/nova/nova.conf placement auth_type password
- crudini --set /etc/nova/nova.conf placement user_domain_name Default
- crudini --set /etc/nova/nova.conf placement auth_url http://127.0.0.1:5000/v3
- crudini --set /etc/nova/nova.conf placement username placement
- crudini --set /etc/nova/nova.conf placement password password
- su -s /bin/sh -c "nova-manage api_db sync" nova
- su -s /bin/sh -c "nova-manage cell_v2 map_cell0" nova
- su -s /bin/sh -c "nova-manage cell_v2 create_cell --name=cell1 --verbose" nova
- su -s /bin/sh -c "nova-manage db sync" nova
- . /root/adminrc && nova-manage cell_v2 list_cells

- systemctl restart nova-api.service
- systemctl restart nova-consoleauth.service
- systemctl restart nova-scheduler.service
- systemctl restart nova-conductor.service
- systemctl restart nova-novncproxy.service

- apt-get -y install nova-compute
- crudini --set /etc/nova/nova.conf DEFAULT transport_url "rabbit://openstack:RABBIT_PASS@127.0.0.1"
- crudini --set /etc/nova/nova.conf api auth_strategy keystone
- crudini --set /etc/nova/nova.conf keystone_authtoken auth_url http://127.0.0.1:5000/v3
- crudini --set /etc/nova/nova.conf keystone_authtoken memcached_servers 127.0.0.1:11211
- crudini --set /etc/nova/nova.conf keystone_authtoken auth_type password
- crudini --set /etc/nova/nova.conf keystone_authtoken project_domain_name default
- crudini --set /etc/nova/nova.conf keystone_authtoken user_domain_name default
- crudini --set /etc/nova/nova.conf keystone_authtoken project_name service
- crudini --set /etc/nova/nova.conf keystone_authtoken username nova
- crudini --set /etc/nova/nova.conf keystone_authtoken password password
- crudini --set /etc/nova/nova.conf DEFAULT my_ip 127.0.0.1
- crudini --set /etc/nova/nova.conf DEFAULT use_neutron True
- crudini --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver
- crudini --set /etc/nova/nova.conf vnc enabled true
- crudini --set /etc/nova/nova.conf vnc server_listen 127.0.0.1
- crudini --set /etc/nova/nova.conf vnc server_proxyclient_address 127.0.0.1
- crudini --set /etc/nova/nova.conf vnc novncproxy_base_url http://127.0.0.1:6080/vnc_auto.html
- crudini --set /etc/nova/nova.conf glance api_servers http://127.0.0.1:9292
- crudini --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp
- crudini --del /etc/nova/nova.conf DEFAULT log_dir
- crudini --set /etc/nova/nova.conf placement os_region_name RegionOne
- crudini --set /etc/nova/nova.conf placement project_domain_name Default
- crudini --set /etc/nova/nova.conf placement project_name service
- crudini --set /etc/nova/nova.conf placement auth_type password
- crudini --set /etc/nova/nova.conf placement user_domain_name Default
- crudini --set /etc/nova/nova.conf placement auth_url http://127.0.0.1:5000/v3
- crudini --set /etc/nova/nova.conf placement username placement
- crudini --set /etc/nova/nova.conf placement password password
- systemctl restart nova-compute.service
- su -s /bin/sh -c "nova-manage cell_v2 discover_hosts --verbose" nova

- mysql -e "CREATE DATABASE neutron;"
- mysql -e "GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' IDENTIFIED BY 'NEUTRON_DBPASS';"
- mysql -e "GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' IDENTIFIED BY 'NEUTRON_DBPASS';"
- . /root/adminrc && openstack user create --domain default --password password neutron
- . /root/adminrc && openstack role add --project service --user neutron admin
- . /root/adminrc && openstack service create --name neutron --description "OpenStack Networking" network
- . /root/adminrc && openstack endpoint create --region RegionOne network public http://127.0.0.1:9696
- . /root/adminrc && openstack endpoint create --region RegionOne network admin http://127.0.0.1:9696
- . /root/adminrc && openstack endpoint create --region RegionOne network internal http://127.0.0.1:9696
